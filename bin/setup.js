#!/usr/bin/env node

const fs = require('fs').promises;
const path = require('path');
const readline = require('readline');
const { spawn } = require('child_process');

// Colors for terminal output
const colors = {
  blue: '\x1b[34m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  red: '\x1b[31m',
  cyan: '\x1b[36m',
  reset: '\x1b[0m',
  bold: '\x1b[1m'
};

function colorLog(color, message) {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

function createInterface() {
  return readline.createInterface({
    input: process.stdin,
    output: process.stdout
  });
}

async function askQuestion(rl, question, defaultValue) {
  return new Promise((resolve) => {
    const prompt = defaultValue 
      ? `${question} (${colors.cyan}${defaultValue}${colors.reset}): `
      : `${question}: `;
    
    rl.question(prompt, (answer) => {
      resolve(answer.trim() || defaultValue);
    });
  });
}

async function validatePath(filePath, type) {
  try {
    await fs.access(filePath);
    return true;
  } catch {
    colorLog('red', `âŒ ${type} path does not exist: ${filePath}`);
    return false;
  }
}

async function createEnvFile(workspacePath, configPath) {
  const envContent = `# Mission Control Configuration
# Generated by setup wizard on ${new Date().toISOString()}

# OpenClaw Integration
OPENCLAW_WORKSPACE=${workspacePath}
OPENCLAW_CONFIG=${configPath}

# Data Directory
DATA_DIR=./data

# Next.js Configuration
NEXT_PUBLIC_APP_URL=http://localhost:3000

# Development
NODE_ENV=development
`;

  const envPath = path.join(process.cwd(), '.env.local');
  await fs.writeFile(envPath, envContent, 'utf-8');
  colorLog('green', `âœ… Created .env.local configuration`);
  return envPath;
}

async function runCommand(command, args = [], options = {}) {
  return new Promise((resolve, reject) => {
    const child = spawn(command, args, {
      stdio: 'inherit',
      shell: true,
      ...options
    });

    child.on('close', (code) => {
      if (code === 0) {
        resolve(code);
      } else {
        reject(new Error(`Command failed with exit code ${code}`));
      }
    });

    child.on('error', reject);
  });
}

async function openBrowser(url) {
  const commands = {
    darwin: 'open',
    win32: 'start',
    linux: 'xdg-open'
  };
  
  const command = commands[process.platform];
  if (command) {
    try {
      await runCommand(`${command} ${url}`);
      colorLog('cyan', `ğŸŒ Opening browser to ${url}`);
    } catch {
      colorLog('yellow', `âš ï¸  Could not auto-open browser. Please visit: ${url}`);
    }
  } else {
    colorLog('yellow', `âš ï¸  Please manually open: ${url}`);
  }
}

async function main() {
  console.clear();
  
  // Header
  colorLog('cyan', `${colors.bold}ğŸ¯ Mission Control Setup Wizard${colors.reset}`);
  colorLog('blue', 'â•'.repeat(50));
  console.log('');
  colorLog('blue', 'Welcome to Mission Control - OpenClaw Command Center');
  colorLog('blue', 'This wizard will help you configure your environment.');
  console.log('');

  const rl = createInterface();

  try {
    // Get OpenClaw workspace path
    colorLog('yellow', 'ğŸ“‚ OpenClaw Workspace Configuration');
    const workspacePath = await askQuestion(
      rl, 
      'Enter your OpenClaw workspace path', 
      '/root/.openclaw/workspace'
    );

    // Validate workspace path
    if (!(await validatePath(workspacePath, 'Workspace'))) {
      colorLog('red', 'âŒ Setup cancelled - invalid workspace path');
      rl.close();
      process.exit(1);
    }

    // Get OpenClaw config path  
    const configPath = await askQuestion(
      rl,
      'Enter your OpenClaw config file path',
      '/root/.openclaw/openclaw.json'
    );

    // Validate config path
    if (!(await validatePath(configPath, 'Config'))) {
      colorLog('red', 'âŒ Setup cancelled - invalid config path');
      rl.close();
      process.exit(1);
    }

    rl.close();

    console.log('');
    colorLog('green', 'âœ… Paths validated successfully!');
    console.log('');

    // Create .env.local file
    colorLog('blue', 'ğŸ“ Creating environment configuration...');
    await createEnvFile(workspacePath, configPath);
    
    // Install dependencies
    colorLog('blue', 'ğŸ“¦ Installing dependencies...');
    colorLog('yellow', 'This may take a few minutes...');
    await runCommand('npm', ['install']);
    colorLog('green', 'âœ… Dependencies installed successfully!');
    
    console.log('');
    colorLog('green', 'ğŸš€ Setup completed successfully!');
    console.log('');
    
    // Start development server
    colorLog('blue', 'ğŸ”„ Starting development server...');
    colorLog('yellow', 'Starting Mission Control on http://localhost:3000');
    
    // Start the dev server in background
    const devServer = spawn('npm', ['run', 'dev'], {
      stdio: 'pipe',
      detached: true
    });
    
    // Give server time to start
    setTimeout(async () => {
      await openBrowser('http://localhost:3000');
      
      console.log('');
      colorLog('green', `${colors.bold}ğŸ¯ Mission Control is now running!${colors.reset}`);
      console.log('');
      colorLog('cyan', 'ğŸ“± Application: http://localhost:3000');
      colorLog('blue', 'ğŸ“š Repository: https://github.com/samjamliaison/mission-control');
      colorLog('yellow', 'ğŸ› ï¸  Stop server: Ctrl+C in the terminal running npm run dev');
      console.log('');
      colorLog('green', 'Happy commanding! ğŸš€');
      
      // Detach the process so it can continue running
      devServer.unref();
      process.exit(0);
    }, 3000);
    
  } catch (error) {
    rl.close();
    console.log('');
    colorLog('red', `âŒ Setup failed: ${error.message}`);
    process.exit(1);
  }
}

// Handle Ctrl+C gracefully
process.on('SIGINT', () => {
  console.log('');
  colorLog('yellow', 'âš ï¸  Setup cancelled by user');
  process.exit(0);
});

main().catch((error) => {
  colorLog('red', `âŒ Fatal error: ${error.message}`);
  process.exit(1);
});